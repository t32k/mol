---
layout: post
title: 第13章 Webブラウザに組み込まれたJavaScript
categories:
- javascript
tags: []
status: publish
type: post
published: true
meta:
  blogger_blog: warikiru.blogspot.com
  blogger_author: t32khttp://www.blogger.com/profile/06797489791220082722noreply@blogger.com
  blogger_permalink: /2009/08/javascript-in-web-browesers.html
  _edit_last: '1'
  pvc_views: '6506'
---
クライアントサイドJavaScript
Webサーバに対するWebブラウザ（クライアント）で使われるJS
<h2>13.1　Webブラウザ環境</h2>
Webブラウザのプログラミング環境について大事なこと
Windowオブジェクト。グローバルオブジェクトの役目
クライアントサイドオブジェクトの階層構造と、この階層構造に含まれるドキュメントオブジェクトモデル
イベント駆動型のプログラミングモデル
<h3>13.1.1　グローバル実行コンテキストとなるWindowオブジェクト</h3>
Documentオブジェクト　HTMLドキュメントに対応する
Windowオブジェクト ドキュメントを表示するウィンドウ（フレーム）に対応する
Windowオブジェクトのプロパティがグローバル変数（以下のコードは同じ意味）
var answer = 42;　　　　　//グローバル変数を宣言し、初期化
window.answer = 42;　　//Windowオブジェクトにプロパティを作成
各ウィンドウまたはフレームにはそれぞれ別個のWindowオブジェクトがある
<h3>13.1.2　クライアントサイドオブジェクトの階層構造とDOM</h3>
クライアントサイドJavaScriptオブジェクトの階層構造で最上位に位置するのがWindowオブジェクト
<ul>
	<li>self,window,parentなど</li>
	<li>navigator</li>
	<li>frames[]</li>
	<li>location</li>
	<li>history</li>
	<li>document</li>
	<li>screen</li>
</ul>
Documentオブジェクトから下位の階層のことをDOMと呼ぶ
<h3>13.1.3　イベント駆動型のプログラミングモデル</h3>
クライアントサイドJavaScriptでもイベント駆動型のプログラミングモデルを採用
ユーザからの入力があるとWebブラウザがイベントを生成
イベントが発生するとブラウザは対応するイベントハンドラを呼び出す
最初から最後まで通して実行される静的なコードブロックと
システムによって非同期に呼び出されるイベントハンドラがある
<h3>13.1.4　WebにおけるJavaScriptの役割</h3>
HTMLがコンテンツを指定し、CSSが表示方法を指定し、JSはそれに対して振る舞いを追加する
JSの役割は、ユーザの利便性を向上し、簡単に情報を取得したり送信したりできるようにすること
JSがなければ操作できないようなインターフェイスは作るべきではない
<h3>13.1.5　控えめなJavaScript</h3>
HTMLとJSを分離する
JSは外部ファイル化してインクルード
イベントハンドラ属性には記述せず、イベントハンドらを各要素に登録する
モジュール化する
正常に機能を停止する
JSコードがなくても使えるように機能テストする
JSのせいでHTMLのアクセサビリティを低下させない
<h2>13.2　HTMLドキュメントへのJavaScriptコードの埋め込み</h2>
SCRIPT要素内に記述
SCRIPT要素のsrc属性で外部ファイルから読み込む
イベントハンドラの場合、onclickやonmouseoverなどのHTML属性値として記述
javascript: URL という形式でURL部分に記述
<h3>13.2.1　&lt;script&gt;タグ</h3>
<pre>&lt;script type="text/javascript"&gt;// ここにコードを記述&lt;/script&gt;</pre>
XHTMLの場合、「&lt;」「&amp;」などがXMLマークアップと見なされるのでCDATAセクション内に記述
<pre>&lt;script type="text/javascript"&gt;&lt;![CDATA[// ここにコードを記述]]&gt;&lt;/script&gt;</pre>
SCRIPT要素はHTMLに現れる順に実行される
あるスクリプトで定義された関数や変数は同じHTMLファイル内で後続するすべてのスクリプトで参照
つまり実行コンテキストはHTMLページ単位
<h3>13.2.2　外部ファイルのスクリプト</h3>
src属性にて外部ファイルを指定

SCRIPT要素内に記述したマークアップ、コードは無性される
<pre>&lt;script src="../js/utility.js"&gt;&lt;/script&gt;</pre>
コンテンツと振る舞いを分離できる
コードの保守性が高くなる
キャッシュによる時間の節約
ほかのWebサーバーからもインクルードできる

スクリプトをインクルードするということは、そのスクリプトの作者と、スクリプトの配布元のWeb管理者、自身のWebページの制御を完全に委ねることになる
<h3>13.2.3　スクリプト言語の指定</h3>
JS以外のスクリプト言語としてIEでサポートされているMSのVisual Basic Scripting Edition (VBScript)しかない。
つまり、スクリプト言語が2種類以上存在することになるのでどちらか指定する必要がある
<pre>&lt;meta http-equiv="Content-Script-Type" content="text/javascript"&gt;&lt;script type="text/javascript"&gt;&lt;/script&gt;</pre>
「text/javascript」はJSプログラム用のMIMEタイプ
「application/x-javascript」というのもある（「x-」から始まるMIMEタイプは実験用つまり非標準を表す）

将来的には「application/javascript」を使うことになるが現時点ではあまりサポートされていない。
<h3>13.2.4　defer属性</h3>
HTMLドキュメントを解析中のブラウザに対してスクリプトの実行を延期してもドキュメントの解析を実行しても問題ないことを教える
IEだけ対応（ドキュメントの解析が終了するまで実行が延期）
<pre>&lt;script defer="defer"&gt;&lt;/script&gt;</pre>
<h3>13.2.5　&lt;noscript&gt;タグ</h3>
ブラウザでJSがオフになっている場合のみに表示されるコンテンツ
ただし、JSが使えなくてもページが利用できるようにしておく。
<h3>13.2.6　&lt;/script&gt;タグ</h3>
HTMLパーサ自体はJSコードを理解しないので『&lt;/script&gt;』の文字列を見つけると、処理を停止する。
"&lt;/" + "script&gt;"のように記述するか、バックスラッシュでエスケープ（"&lt;\/script&gt;"）しなければならない
XHTMLではCDATAセクション内に記述するので上記のような問題は発生しない
<h3>13.2.7　古いブラウザからスクリプトを見えないようにする</h3>
古いブラウザだと&lt;script&gt;タグを認識しないためタグ内のテキストを表示してしまう問題がある
<pre>&lt;script&gt;&lt;!--//ここにコードを記述//--&gt;&lt;/script&gt;</pre>
上記のようにすれば問題ないが、そのような対策をする必要のあるブラウザがもうないので、このようなテクニックは必要ない
<h3>13.2.8　&lt;script&gt;タグの非標準属性</h3>
IEでの独自実装にevent属性とfor属性ってのがあるけど、使わないで！
<h2>13.3　HTMLドキュメント内のイベントハンドラ</h2>
onclick : A要素やAREA要素、ボタンタイプのフォーム要素でサポート。
onmousedown, onmouseup : マウスカーソルがある要素の上に移動したとき、上から離れたとき
onchange : INPUT,SELECT,TEXTAREA要素でサポート。値を変更した時や、フォーカスを移動したときに呼び出される
onload : BODY要素のみサポート。onloadイベントが発生したということはドキュメントが完全に読み込まれた状態が安定しドキュメントが変更可能という意味
控え目なJavaScriptという考えではイベントハンドラを属性で使用するのではなく、JS側から指定することが望ましい。
<h2>13.4　URLへのJavaScriptの記述</h2>
javascript:疑似プロトコルという形式
コメントは「//」ではなく「/* */」を使う
<pre>javascript:var now = new Date(); "&lt;h1&gt;The time is : &lt;/h1&gt;" + now;</pre>
値を返すと現在のドキュメントを上書きすることもあるので、それを避けたい場合
void 0;をつけることで、undefined値を返すようにする
javascript:window.open("about:blank"); void 0;
JavaScript URL とイベントハンドラはほとんど同じ
<h3>13.4.1　ブックマークレット</h3>
ブックマーク中にJavaScript URL を使って小さなJavaScriptプログラムを記述したもの
JavaScript URL は複数行に分けて記述してもHTMLパーサは1行として扱う
<h2>13.5　JavaScriptプログラムの実行方法</h2>
<h3>13.5.1　スクリプトの実行</h3>
&lt;script&gt;タグと&lt;/script&gt;タグとの間に記述された純に実行される
1つのファイルに複数のスクリプトがある場合ファイルに記述された順に実行
スクリプトはHEAD要素やBODY要素にも記述できる
一般的にHEAD部では関数の定義や変数の宣言と初期化を行うのが普通
<h3>13.5.2　onloadイベントハンドラ</h3>
ドキュメントの解析が完了し、すべてのスクリプトが実行され、画像などの外部コンテンツがすべて読みこまれるとブラウザはonloadイベントを生成
ドキュメントの内容を変更するようなJSモジュールをイベントハンドらに指定するのが普通
onloadイベントハンドラでdocument.write()を呼び出すと新しいドキュメントで上書きしてしまう
<h3>13.5.3　イベントハンドラとJavaScript URL</h3>
ドキュメントロードと解析が終了するとJavaScriptはイベント駆動型に切り替わる
&lt;script&gt;要素で関数を定義して、ユーザーの入力に応じてイベントハンドラからこの関数を呼び出すのが一般的
<h3>13.5.4　onunloadイベントハンドラ</h3>
ユーザーがあるページから移動しようとするときにブラウザからonunloadイベントハンドラが呼び出される
onunloadイベントハンドラに時間のかかる処理をいれないように。
<h3>13.5.5　実行コンテキストとしてのWindowオブジェクト</h3>
スクリプト中の変数や関数の寿命はドキュメントが新しいドキュメントに置き換わるまで
<h3>13.5.6　クライアントサイドJavaScriptのスレッドモデル</h3>
JavaScriptのコア言語にはスレッド機構は存在しない
クライアントサイドJavaScriptはシングルスレッド
スクリプトがロードされ実行される間はドキュメントの解析を停止するし、イベントハンドラが実行される間、ブラウザはユーザの入力に対して応答しない
2つのイベントハンドラが同時に実行されないという前提
時間のかかる処理をすればドキュメントのロードに遅延が生じる可能性がある
可能ならば、setTimeout()やsetInterval()のメソッドを使ってバックグラウンドで少しづつ処理を実行し、実行状況をユーザに提示したほうがよい
<h3>13.5.7　ロード時のドキュメントの操作</h3>
経験豊かなJavaScriptプログラマの間では&lt;script&gt;タグ中でドキュメントを操作すると問題が発生するかもしれないという漠然とした不安が依然として存在している
onloadイベントが発生した後であればドキュメントを安全に操作できる
ドキュメント操作用のコードをドキュメントの最後に記述する方法（IEのdefer属性注意）
<h2>13.6　クライアントサイドJavaScriptの互換性</h2>
Windows/Mac OS/Linux, Internet Exploer/Firefox/Safari/Operaなどプラットフォーームの組み合わせは27種類にも及ぶ
ベンダ間、バージョン間、、プラットフォーム間で互換性のあるプログラムを作るには非互換性を学ばなくてはならない
<h3>13.6.1　非互換性の歴史</h3>
Microsoft VS Netscape
Microsoftが市場を独占し、DOMやＣＳＳなどWeb標準を確立
WHATWGなどまた新たな対立の雰囲気がないわけでもない
<h3>13.6.2　「最近のブラウザ」の意味するもの</h3>
本書でゆう『最近のブラウザ』が意味するのものは、Fx1.0,1.5, IE5.5,6.0, Safari2.0, Opera8,8.5
<h3>13.6.3　機能テスト</h3>
能力テストとも呼ばれる
すべてのブラウザでサポートされているわけでない機能を使う場合はその機能がサポートされているかどうかテストするコードを追加する
addEventListenerやXMLHttpRequestなど
ただし、機能テストがうまく動作するには、完全に機能しないプロパティやメソッドをブラウザが定義しないということが前提
<h3>13.6.4　ブラウザテスト</h3>
機能テストはある関数グループがサポートされているかどうかチェックするのに向いている
ある特定のブラウザ特有のバグが存在するかどうかテストする方法は難しい
Ｎａｖｉｇａｔｉｏｎオブジェクトなど利用して、ブラウザのベンダやバージョンを判定するコードをブラウザスニファやクライアントスニファと呼ぶ
クライアントの判定はサーバ側でもできる（User-Agentヘッダ）
<h3>13.6.5　Internet Explorerの条件付きコメント</h3>
<pre>&lt;!--[if IE]&gt;この部分は、実際にはHTMLコメントの中。IEでのみ表示される。&lt;![endif]--&gt;

&lt;!--[if gte IE 6]&gt;この部分は、IE6以降でのみ表示される。&lt;![endif]--&gt;

&lt;!--[if !IE]&gt; &lt;--&gt;この部分は、通常のHTMLの内容。ただし、IEではコメント中に含まれる。&lt;!--&gt; &lt;![endif]--&gt;</pre>
IEのJavaScriptインタプリタでも条件付きコメントはサポートされている。
/*@cc_onと@*/の間に記述
<h2>13.7　アクセサビリティ</h2>
音声読み上げツールの対応は？
マウスが使えなくてもＯＫ？
キーボードが使えなくてもＯＫ？
JavaScriptをオフのときもうまく動作し、装置に依存しないイベントを使うことが望ましい
<h2>13.8　JavaScriptのセキュリティ</h2>
<h3>13.8.1　JavaScriptではできないこと</h3>
コンピュータ上のファイルやディレクトリに対して、読み出し、書き込み、作成、削除、表示ができない。
JavaScript自体はネットワークをサポートしていないのでソケットを開いたり、ほかのホストからの接続を受け付けたりはできない

マウスクリックなどのユーザ操作に応答するときしかブラウザウィンドウを新規にオープンできない
JSプログラムがクローズできるのはそのプログラムがオープンしたウィンドウだけ。
ステータス行に表示されるリンクの飛び先はJSから変更できない
１辺が100px未満のウィンドウをオープンしたり、ウィンドウサイズを100px未満に変更できない
HTMLのFileUpload要素のvalueプロパティには値を設定できない
スクリプトを含んでいるドキュメントをロードしたサーバとは異なるサーバからロードされたドキュメントの内容をを、そのスクリプトから読みだすことはできない
<h3>13.8.2　同一出身ポリシー</h3>
Webコンテンツにアクセスする際に適用されるセキュリティ機構
同一出身ポリシーはあるウィンドウ（フレーム）のJSコードと別のウィンドウ（フレーム）のコード間のやり取りを管理
つまり、あるスクリプトはそのスクリプトを含むドキュメントと同じ出身のウィンドウやドキュメントのプロパティしか読み出せない
ドキュメントの『出身』とはそのドキュメントがロードされたURLのプロトコルとホストとポート番号を組み合わせたもの
http:とhttps:では出身が異なる
同一出身ポリシーで関係するのはスクリプトが埋め込まれているドキュメントの出身
同一出身ポリシーはスクリプトを使って機密情報を盗めないようにする機構
サブドメインなど利用する大規模サイトではDocumentオブジェクトのdomainプロパティをつかってデフォルトの値を変更する
（設定できるのはドメインサフィックスを表す文字列だけ）
<h3>13.8.3　プラグインやActive Xコントロールの制御</h3>
クライアイントサイドJSはファイルシステム機能やネットワーク機能がないため悪意のあるコードはかけない
しかし、Active Xやプラグインを介することでセキュリティの問題がでてくるかも
<h3>13.8.4　クロスサイトスクリプティング</h3>
攻撃者が攻撃対象のWebサイトに対してHTMLタグやスクリプトを注入することで発生するセキュリティ問題の総称
HTMLタグを削除する処理のことをサニタイズ（無害化）と呼ぶ
<h3>13.8.5　DoS攻撃</h3>
DoS(denial-of-service:サービス不能)
無限ループや意味のない計算を行うことでCPUを機能停止に追い込む攻撃
<h2>13.9　そのほかのWeb関連の組み込みJavaScript</h2>
<strong>ユーザスクリプティング</strong>
有名な例にFirefoxのGreasemonkey拡張がある

<strong>SVG（Scalable Vector Graphics）</strong>
XMLベースのグラフィックフォーマット
ＳＶＧファイル内にJSを埋め込むことでXMLを操作できる

<strong>XUL</strong>
ユーザインタフェースを記述するためのXMLベースの書式
FirefoxのＧＵＩもXULで定義されている

<strong>ActionScript</strong>
Flashムービー中に使われるJSに似た言語
