<p>秋色日毎に深まりこんちわ、<a href="https://twitter.com/t32k">@t32k</a>だ。<a href="http://t32k.me/mol/log/remote-debugging-with-chrome-for-android/">前回も</a>少し言いましたが<a href="https://developers.google.com/speed/pagespeed/insights#url=http_3A_2F_2Ft32k.me_2Fmol_2F&amp;mobile=true">PageSpeedにモバイル版</a>というのがありまして、デスクトップ版とは少々違うことをこいつは物申してきます。テストするページにもよりますが例えば、デスクトップ版であれば、「<strong>ブラウザのキャッシュを活用する</strong>」や「<strong>圧縮を有効にする</strong>」がHigh priorityな対策としてよく指摘されます。モバイル版でもそれらは重要かつ効果のある対策ですが、さらに対応しておきたいのが「<strong>JavaScript の解析を遅延する</strong>」という対策です。</p>

<p>ざっくり言えば、そのJavaScriptが本当に必要になるまで後にとっておくということです。スマホなどの携帯端末は言うまでもなく、デスクトップPCに比べれば非力なので、このような端末ではJavaScriptを解析するのにもなかなか時間を要してしまうので、注意しましょうってことです。</p>

<p>PCサイトで、それも単純にドキュメント閲覧のようなページのパフォーマンス対策なんて、HTTPリクエストを減らすことだけ考えていれば十分事足りるなぁと個人的には考えています。ただ、最近やってるお仕事はスマホ向けのWebアプリ制作でして、JSゴリゴリ使ってます。。。この辺りのパフォーマンス対策というのをもうちょっと真剣に考えたいお年頃になってきたので、今回がんばってみます。</p>

<p>ただ、僕はJSは書けないので難しいことはよく分からんとです。お先真っ暗、八方塞がりです。唯一気になっていることは今のプロジェクトでhead要素に入れてあるGoogleアナリティクスのスニペットって本当にここでいいのか？ということです。これね、これ↓</p>
<pre><code class="javascript">&lt;script type="text/javascript"&gt;
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-XXXXX-X']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
&lt;/script&gt;</code></pre>
<div><!--more--></div>
<ul>
	<li><strong><a href="http://t32k.me/mol/log/asynchronous-tracking/">Google Analytics 非同期トラッキングコード再考 | MOL</a></strong></li>
</ul>
<p>はい、2年前にこの記事を書いたのは僕でして、そこでは<code>&lt;/head&gt;</code>の直前に入れるということで結論づけました。ただこれはPCサイト前提での話なので、今のスマホ時代にも通じるのかもう一度考えてみましょう。</p>
<h2>script要素の読み込みと評価</h2>
<p style="text-align: center;"><a href="/static/blog/2012/09/fig_1.png"><img class="aligncenter" src="/static/blog/2012/09/fig_1.png" alt="JavaScript resource fetching, parsing and evaluation" width="500" /></a></p>
<p style="text-align: right;"><a href="http://calendar.perfplanet.com/2011/lazy-evaluation-of-commonjs-modules/">Performance Calendar » Lazy evaluation of CommonJS modules</a> より</p>
<p>script要素を入れることでかかるコストについて上記の図のような感じですね。LatencyとDownloadが読み込みに関わるところで、普通にscript要素を読み込むと、通常のリソースは並列ダウンロードできるのに対して、script要素は他のリソースのダウンロードをブロッキングします。まぁ、scriptを早い段階で読み込むとそれだけページ表示に余計に時間がかかってしまいます。この点でノンブロッキングな読み込みを実現したのがGoogle Analyticsの非同期トラッキングコードで並列ダウンロードが可能となりました。また、トラッキング用のJSファイルにはga.jsには12時間の有効期限が設定されているので、次ページビュー、当日中くらいのセッション再開後もキャッシュが有効となり、LatencyとDownloadの部分は省略できます。</p>

<p>ただ、お気付きの通りParsingとEvaluationはキャッシュがあろうがなかろうが毎回コストを支払わなければなりません。しかもParsingとEvaluationの実行中はレンダリングが止まってしまいます。PCサイトであればこの点が無視できるほど短い時間で完了するので、head要素においても大した影響がないということでした。事実、<a href="https://twitter.com/tobie">@tobie</a>さんの<a href="http://calendar.perfplanet.com/2011/lazy-evaluation-of-commonjs-modules/">記事でもjQeuryのParsingとEvaluation</a>のコストはMacBook Proが<strong>35ms</strong>に対して、iPhone4が<strong>320ms</strong>かかっている調査結果でした。つまり、jQueryを使おうが使わまいが、キャッシュが効いてようが効いてまいが、iPhone４ユーザーはjQueryが読み込まれている時点で毎回320ms（設置場所によっては）レンダリングが止まる時間ができるということです。</p>

<p>[caption id=”” align=”aligncenter” width=”500”]<a href="http://www.slideshare.net/souders/javascript-performance-at-sfjs"><img class=" " src="/static/blog/2012/09/load_scripts_async.png" alt="2009 load scripts async" width="500" height="375" /></a> Google Analyticsの非同期トラッキングコードはノンブロッキングに読み込みできるが、<br />script実行中はレンダリングを止める。[/caption]</p>
<h2>Google Analyticsの実行コスト</h2>
<p>そこでこのjQueryのテストのGoogle Analytics版を作ってみました。</p>
<ul>
	<li><a href="http://dl.dropbox.com/u/356242/cost_ga.html">http://dl.dropbox.com/u/356242/cost_ga.html</a></li>
</ul>
<p>Google Analyticsは基本的にページビュー計測を目的に入れると思いますので、単純に評価だけでなく毎ページごと実行（ビーコン画像発行）されると想定したテストです。
&lt;p style="text-align: center;"&gt;<a href="/static/blog/2012/09/fig2.png"><img class="aligncenter" src="/static/blog/2012/09/fig2.png" alt="" width="500" /></a>&lt;/p&gt;
上記のページで10回アクセスしてその平均値をグラフにしました。詳細は下記スプレッドシートにまとめてあります。</p>
<ul>
	<li><a href="https://docs.google.com/spreadsheet/ccc?key=0ApycgWz4whD1dHhIWXVSTTRobEN1elFtYndPb0FIcFE#gid=0">Cost of Execute Google Analytics</a></li>
</ul>
<p>iPhone3Gは論外ですけど、今現在でも広く使われてそうな機種（iPhone4やGALAXY S2）でも100ms~200msくらい実行に時間がかかっています。これがhead要素に入ってるこということは、それ以降のレンダリングが100ms~200msストップしているということになります。（実際の実装状況をかんがみるともう少し掛かりそうな気がする）</p>

<p>100msというとニールセン博士の<a href="http://www.usability.gr.jp/alertbox/20100621_response-times.html">ウェブサイトの応答時間</a>では<strong>“0.1秒までなら応答が瞬時に返ってきたという印象を与える</strong>“と述べていますので、Google Analytics だけでこの貴重な0.1秒使ってしまうことは非常にもったいないと個人的には考えます。</p>
<h2><code>&lt;/head&gt;</code>か<code>&lt;/body&gt;</code>か</h2>
<p>では、単純に<code>&lt;/body&gt;</code>の直前にスニペットを配置しても問題無いのでしょうか？Steve Soudersは<a href="http://www.slideshare.net/souders/javascript-performance-at-sfjs">JavaScript Performance (at SFJS)</a>でGoogle Analyticsのスニペットの設置場所についてまとめています。</p>

<p>http://www.youtube.com/watch?v=0AP15IXFBnc</p>

<p><strong><code>&lt;/head&gt;の場合</code></strong></p>
<ul>
	<li>script loads later</li>
	<li>beacon fires later</li>
	<li>blocks fewer async(Opera)</li>
	<li>may block rendering</li>
</ul>
<p><strong><code>&lt;/body&gt;の場合</code></strong></p>
<ul>
	<li>script loads last</li>
	<li>beacon fires late</li>
	<li>doesn’t block async</li>
	<li>doesn’t block rendering</li>
</ul>
<p>はい、結局トレードオフの関係にあります。スニペットを単純に下に置けばレンダリングをブロックしませんが、その分ビーコン画像の発行が遅れます。そもそも、非同期トラッキングコードがリリースされた時のメリットにデータの収集・精度の向上が挙げられています。つまり、スニペットがページ下部にあればページを完全にロードしないで次のページへ遷移してしまった人などが計測できなくなります。この部分をどう捉えるかで設置場所は決まってくるでしょう。</p>

<p>そもそも、ページ読み込み完了も待てないページビューをページビューとしてカウントしてもいいもなのかという個人的な疑問もあります。というより、ユーザーの満足度 &gt;&gt;&gt; (越えられない壁 )  &gt;&gt;&gt; アクセス解析の精度だと考えるので僕はスマホサイトに関しては<code>&lt;/body&gt;</code>の直前に設置したほうが良いと考えます。(スマホ用のga.js作ればいいのにと思ったり。jQueryにおけるZeptoみたいにIE対応とか考えなかったらもう少しシンプル・軽量化出来ると思うけど。)</p>

<p>ちなみに、<a href="https://github.com/h5bp/html5-boilerplate/blob/master/index.html">HTML5のボイラープレート</a>（ひな形）を見てみると、デスクトップ、モバイル版ともに&lt;/body&gt;の直前に配置されています。</p>
<blockquote>Finally, an optimized version of the latest Google Analytics tracking code is included. Google recommends that this script be placed at the top of the page. Factors to consider: if you place this script at the top of the page, you’ll be able to count users who don’t fully load the page, and you’ll incur the max number of simultaneous connections of the browser.
<p style="text-align: right;"><a href="https://github.com/h5bp/html5-boilerplate/blob/master/doc/html.md#google-analytics-tracking-code">Google Analytics Tracking Code</a></p>
</blockquote>
<p>注意書きとしても同じようなことが言われています。あと、head要素に置けばビーコン画像リクエストによる同時接続数の1つを消費してしまうことも懸念点としてあげられています。</p>

<p>最後に自分が使ってるスニペット置いときますね。</p>
<pre><code class="javascript">&lt;script id="gaq"&gt;
　var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
　(function(d){var g=d.createElement('script'),s=d.getElementById('gaq');g.async=1;
　g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
　s.parentNode.insertBefore(g,s)}(document));
&lt;/script&gt;</code></pre>
<p><a href="https://gist.github.com/3792738">Google Analytics Tracking Snippet — Gist</a></p>
<h3>あわせて読みたい</h3>
<ul>
	<li><a href="http://readhn-jp.blogspot.jp/2012/02/javascript.html">ブラウザって毎回Javascriptを解析するの？</a></li>
	<li><a href="http://mathiasbynens.be/notes/async-analytics-snippet">Optimizing the asynchronous Google Analytics snippet · Mathias Bynens</a></li>
	<li><a href="http://tokkono.cute.coocan.jp/blog/slow/index.php/web-technology/non-blocking-asynchronous-loading-of-css-javascript/">CSS/JavaScriptのAsynchronous Loadingをめぐる熱い論議 | ゆっくりと…</a></li>
</ul>
