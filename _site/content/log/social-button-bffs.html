<p>ども、実兄からFacebook友達申請きて承認を見送るt32kです。そんなソーシャル時代ですけどみなさんいかがお過ごしか？みなさんはこうは思わないだろうか？いいね！ボタンなどのソーシャルボタンはいっぱいあるけど、どうゆうふうに実装すればいいのよ！スニペット、コピペでいいの？ってね。そんなこと考えていたら、いい記事があったので翻訳してみたよの巻。</p>

<p><cite class="citation">
<img src="/mol/images/people/stoyan_stefanov.jpg" alt="" />
Original：<a href="http://www.phpied.com/social-button-bffs/">Social button BFFs</a>（<time>2011-09-27</time>）by <a href="http://www.phpied.com/bio/">Stoyan Stefanov</a>
</cite></p>

<p>TL;DR:JavaScriptの非同期読み込みはWebアプリのパフォーマンスにおいて重要な問題だ。以降に書かれている内容は一般的なソーシャルボタンに共通する取り扱い方についての記事であり、ソーシャルボタンに残りのコンテンツ読み込みをブロックさせないことを学べるだろう。結局のところ、ユーザーはあなたの <strong>コンテンツを最初</strong>  に見たいのであって、それから、そのコンテンツがシェアする価値があるのか決めるのである。</p>

<p>現在、FacebookはJavaScript SDKを読み込むための新しい非同期スニペットを提供している。そのSDKとは<a href="https://developers.facebook.com/docs/reference/javascript/">とてもパワフルな</a>ソーシャルプラグイン（例：いいね！ボタン）を利用するのために必要なものだ。</p>

<p>これまでもJS SDKは非同期読み込みできたが、最近このパターンがデフォルトになった。そのスニペットは極めてナイスでチクショーな（知ってる、正解！）感じだが、ここではどのようになってるか見てみるとする。（<a href="https://developers.facebook.com/docs/reference/plugins/like/">コードはここから入手</a>）</p>

<p><code>javascript
(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</code></p>

<p>私の<a href="http://www.jspatterns.com/">JavaScriptパターン</a>からナイスなとこを抜き出してみる。</p>

<ul>
  <li>即時（自己呼び出し）関数なので、グローバル変数を汚さない</li>
  <li>よく使う( <code>document</code>)オブジェクトと文字列（”scripts”, “Facebook-jssdk”）はその即時関数の引数として渡される。可読性を保ちながらできる初歩的な縮小化テクニックである</li>
  <li>生成したscriptノードはドキュメントで使用されている最初の <code>script</code>要素を利用することによって追加される。あなたのコードが <code>body load="..."</code>や、img onload、もしくはそれ同様（ぶっ飛んだ方法を私は知っていますが、とりあえずは0.01%くらい寛大に受け止めよう）のパターンで呼び出されない限り、99.99%確実に動作することを保証できる</li>
  <li>追加したノードにはidが割り当てられることで2回同じScriptを読み込むのを防止する（例：ヘッダーや、フッター、記事でいいね！ボタンが使用されているとか）</li>
</ul>

<h2 id="js">ソーシャルボタンのJSファイルすべて</h2>

<p>他のソーシャルボタンも存在する。有名なところで<a href="https://twitter.com/about/resources/buttons#tweet">Twitter</a>と<a href="http://www.google.com/intl/en/webmasters/+1/button/index.html">Google +1</a> ボタンだ。これら両方のボタンは、デフォルトかどうか分からないが、各々の設定次第で非同期読み込みが可能だ。</p>

<p>それではなぜすべてうまいことやってけないのか、そしてfacebookの即時関数中に全部収めることがきないのか？私たちはHTMLのバイト数を少しでも削りたいし、余計なscriptタグなんていらないのだ。Google+やTwitterなどのすべてのソーシャルボタンのために新しいscriptノードが必要だ。Google+のスニペットには <code>type</code>や <code>async</code>などの属性を持っているが、実際これらは必要ないのだ。なぜなら <code>type</code>は常に  <code>text/javascript</code>だし、 <code>async</code>はいつも <code>true</code>だから。加えて今async部分をいじってるのだから。</p>

<p>結果がこれだ。</p>

<p><code>html
&lt;div id="fb-root"&gt;&lt;/div&gt;
&lt;script&gt;
    (function(d, s, id) {
    // fb + common
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
    // +1
    js = d.createElement(s);
    js.src = 'https://apis.google.com/js/plusone.js';
    fjs.parentNode.insertBefore(js, fjs);
    // tweet
    js = d.createElement(s);
    js.src = '//platform.twitter.com/widgets.js';
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
&lt;/script&gt;
</code></p>

<p>これは3つのボタン・プラグインで必要な3つのJSファイルを読み込んでいる。</p>

<p>追加で、ノードの生成・追加部分は関数でラッピングができ、コードが引き締まった。最終的なスニペットはこれだ。</p>

<p><code>html
&lt;div id="fb-root"&gt;&lt;/div&gt;&lt;!-- fb needs this --&gt;
&lt;script&gt;
    (function(d, s) {
        var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.src = url; js.id = id;
        fjs.parentNode.insertBefore(js, fjs);
        };
        load('//connect.facebook.net/en_US/all.js#xfbml=1', 'fbjssdk');
        load('https://apis.google.com/js/plusone.js', 'gplus1js');
        load('//platform.twitter.com/widgets.js', 'tweetjs');
    }(document, 'script'));
&lt;/script&gt;
</code></p>

<h2 id="section">ソーシャルボタンのマークアップすべて</h2>

<p>次は実際にウィジェットがレンダリングされ箇所についてアドバイスする。Facebookは&lt;fb:like&gt;のようなXFBMLシンタックスでのスニペット提供をしているが、data-*属性を用いた純粋なHTML(5)のスニペットも提供しており、ラッキーなことに他のボタンもそうだ。</p>

<p>これが例である。</p>

<p><code>html
&lt;!-- facebook like --&gt;
&lt;div class="fb-like" data-send="false" data-width="280"&gt;&lt;/div&gt;
&lt;!-- twitter --&gt;
&lt;a class="twitter-share-button" data-count="horizontal"&gt;Tweet&lt;/a&gt;
&lt;!-- g+ --&gt;
&lt;div class="g-plusone" data-size="medium"&gt;&lt;/div&gt;
</code></p>

<p>Google+は <code>g-plusone</code>クラス属性がついた <code>div</code>要素が必須であり、Twitterは <code>twitter-share-buttonク</code>ラス属性の <code>a</code>要素が必須である。Facebookはいいね！なら <code>fb-like</code>クラス属性がついたどの要素を扱でも使用できる（もしくは <code>fb-comments</code>、 <code>fb-recommendations</code>、または君の使いたい<a href="https://developers.facebook.com/docs/plugins/">ソーシャルプラグイン</a>名で）</p>

<p>最も重要なことはJSファイルは一回だけ読み込みさえすれば良いことであり、そうすべきだ。読み込めばすべての異なるボタンがレンダリングされる。Facebookのケースにおいても全てのプラグインがレンダリングされる。いいね！ボタンだけでない。JSファイルの容量を考えて効率良く使おう。</p>

<h2 id="section-1">まとめ</h2>

<p>ではこれがソーシャルボタンを読み込むためのベストプラクティスだ。</p>

<ol>
  <li>JSスニペットをページの下部、ちょうど&lt;/body&gt;の直前にコピーする。念の為にね。（Google+はJSファイルの後にマークアップがあった時失敗する）これはまた読み込みのためのJSがひとつにまとまり確認しやくすなっている。スニペットの重複・排除の手間はあるとはいえ。</li>
  <li>適切な設定値をdata-＊属性に付与し、ページの好きなところにボタン・プラグインを撒き散らしちゃいな！</li>
  <li>ソーシャルトラフィックの恩恵に預かっちゃいな！</li>
</ol>

<p>動作に関しては以前の私のブログ <a href="http://phonydev.com/">phonydev.com</a> で確認できる。そうだね、どのボタンもナイスな感じでモバイルでも動いてる。</p>

<hr />

<p>だいたい、最近のソーシャルボタンのスニペットは非同期化してるから個別の非同期化処理がオーバヘッドする。それが解消できるのは良いかと。あとこのボタンのscriptどこよ？ってこともまとめることでなくなると思うので便利かなと思いました。てことで、mixiとhatenaも加えた日本語バージョンのサンプル置いておきますね。</p>

<ul>
  <li><a href="https://dl.dropboxusercontent.com/u/356242/test/loading_social_button/index.html">Loading Social Buttons JavaScript</a></li>
</ul>

<p>あとGoogle アナリティクスのスニペットもまとめられるけど、個人的には分けておいてもいいかなと思う（管理的に）。</p>
