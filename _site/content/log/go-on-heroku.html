<p><a href="http://qiita.com/advent-calendar/2014/heroku">Heroku Advent Calendar 2014 - Qiita</a> の23日目です、たぶん。</p>

<p>最近、僕の周りの人らがGO!GO!うるさいので、ついつい僕もそそのかされてGo言語やりたいなーと思ったのです。<a href="https://golang.org/doc/go1.4">Go 1.4</a>も出たしね。</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[A Tour of Go</td>
          <td>Hello, 世界](http://go-tour-jp.appspot.com/#1)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p>ひととおりチュートリアルはやってみたんですけど、やっぱりWeb上で動かしたいわけですよ。そうゆうわけで、Heroku上でGoアプリを動かしてみようと思います。</p>

<h2 id="go-on-heroku">Go on Heroku</h2>

<ul>
  <li><strong><a href="https://mmcgrana.github.io/2012/09/getting-started-with-go-on-heroku.html">Getting Started with Go on Heroku</a></strong></li>
</ul>

<p>まぁ、上記の記事を参考にしたらちゃんとGoアプリをHerokuで稼働させることができます。以下は自分の備忘録代わりということで。</p>

<h3 id="install-go">Install Go</h3>

<p><a href="https://bitbucket.org/ymotongpoo/goenv">goenv</a>というGoのバージョン管理ツールもあるみたいだけど、初心者なので<a href="http://brew.sh/">Homebrew</a>で入れることにする。</p>

<p><code>sh
$ brew install go
$ go version
go version go1.3.3 darwin/amd64
</code></p>

<p>わーい、かんたん٩(๑❛ᴗ❛๑)۶</p>

<h3 id="go-environment">Go Environment</h3>

<p><code>$GOPATH</code>等を設定する。ここで指定したパス以下がGoのワークスペースとなる。お好きなシェルプロファイルに記述。</p>

<p><code>sh
$ echo 'export GOPATH=$HOME' &gt;&gt; $HOME/.bash_profile
$ echo 'export PATH=$PATH:$GOPATH/bin'  &gt;&gt; $HOME/.bash_profile
</code></p>

<p>以下のようなディレクトリ構成で管理される。</p>

<p><code>sh
$GOPATH
├── bin（コンパイルしたバイナリファイル）
├── pkg（パッケージオブジェクトファイル）
└── src（Goの作業ソースファイル）
</code></p>

<p>GitHub上に置かれているソースファイルは、 <code>~/src/github.com/{USER_NAME}/{REPOSITORY_NAME}</code> みたいに管理される。</p>

<ul>
  <li><a href="http://weblog.bulknews.net/post/89635306479/ghq-peco-percol">ghq + peco/percol - Tatsuhiko Miyagawa’s blog</a></li>
  <li><a href="http://webtech-walker.com/archive/2014/06/peco-ghq-gh-open.html">peco、ghq、gh-openの組み合わせが捗る - Webtech Walker</a></li>
</ul>

<p>だもんでghqの方もそっち合わせてpecoとか使うと捗るらしいよ。</p>

<p><code>sh
git config --global ghq.root ~/src
</code></p>

<p>ghqでgetしてきたリポジトリの保存先の設定。</p>

<ul>
  <li><a href="https://github.com/motemen/ghq">motemen/ghq</a>（Go言語製、リポジトリ管理ツール）</li>
  <li><a href="https://github.com/peco/peco">peco/peco</a>（Go言語製、フィルタリングツール）</li>
  <li><a href="https://github.com/typester/gh-open">typester/gh-open</a>（Go言語製、GitHubのレポジトリURLを開くツール）</li>
</ul>

<p>まとめると、上みたいな感じ。世の中便利ですな。</p>

<p>ちなみに、Intellij IDEAでGolangのプラグイン（0.9.15）を入れると、ちゃんと指定しているのにもかかわらず、$GOROOTと$GOPATH設定しろや、(ﾟДﾟ)ｺﾞﾙｧ!!って言われるけど、0.9.16-alpha入れると治った٩(๑❛ᴗ❛๑)۶</p>

<ul>
  <li><a href="https://github.com/go-lang-plugin-org/go-lang-idea-plugin/releases">Releases · go-lang-plugin-org/go-lang-idea-plugin</a></li>
</ul>

<p>んで、$GOROOTは設定しなくてもいいらしい。</p>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>[あなたがGOROOTを本当に設定しなくていい理由</td>
          <td>Androg](http://kwmt27.net/index.php/2013/06/14/you-dont-need-to-set-goroot-really/)</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h3 id="go-web-app">Go Web App</h3>

<p>話が逸れたので戻すと<code>~/src/demoapp</code>のディレクトリを作ってそこで作業する。</p>

<p><code>sh
$ mkdir $GOPATH/src/demoapp
$ cd $GOPATH/src/demoapp
</code></p>

<p><code>web.go</code>のファイルを作成する。</p>

<p>```go
// web.go
package main</p>

<p>import (
    “fmt”
    “net/http”
    “os”
)</p>

<p>func main() {
    http.HandleFunc(“/”, hello)
    fmt.Println(“listening…”)
    err := http.ListenAndServe(“:”+os.Getenv(“PORT”), nil)
    if err != nil {
      panic(err)
    }
}</p>

<p>func hello(res http.ResponseWriter, req *http.Request) {
    fmt.Fprintln(res, “hello, world”)
}
```</p>

<p>んで、<code>go get</code>（コンパイル、インストール）して、demoappをバイナリで動かすようにする。</p>

<p><code>sh
$ PORT=5000 demoapp
$ open http://localhost:5000/
</code></p>

<p>ローカル環境で動いてることを確認する。</p>

<h3 id="heroku-setup">Heroku Setup</h3>

<p><code>heroku login</code>とかしとく。</p>

<p><code>sh
$ echo 'web: demoapp' &gt; Procfile
</code>
Procfileを作る。</p>

<p><code>sh
$ go get github.com/kr/godep
</code></p>

<p>Godepという依存性の管理ツールをインスコ。</p>

<p><code>sh
$ godep save
</code></p>

<p>依存性を保存。</p>

<p><code>sh
$ heroku create --buildpack https://github.com/kr/heroku-buildpack-go.git
</code></p>

<ul>
  <li><a href="https://github.com/kr/heroku-buildpack-go">kr/heroku-buildpack-go</a></li>
</ul>

<p>GoのHeroku Buildpackを使ってHerokuアプリを作成する。ちなみに、BuildpackとはHeroku上でアプリをコンパイルするためのスクリプトで、Goなどのデフォルトで対応していない言語は<a href="https://devcenter.heroku.com/articles/third-party-buildpacks">Third-PartyのBuildpack</a>を使ってデプロイすることになる。だもんで、Go言語以外も動かせる。</p>

<p>Buildpackを使ってアプリで来たら、<code>git push heroku master</code>してデプロイして完了！</p>

<p>わーい、できたー٩(๑❛ᴗ❛๑)۶</p>

<h2 id="a-fast-heroku-cli-client">A fast Heroku CLI client</h2>

<p>ちなみに、Go言語製のCLIツールが多いのにお気づきだろうか。なんか速いらしいね。ってことで、<code>heroku</code>コマンドも<code>hk</code>というGoで作らたコマンドがある。</p>

<ul>
  <li><a href="https://github.com/heroku/hk">heroku/hk</a></li>
</ul>

<p>まだBeta版でherokuにあってhkに無いコマンドもありますが。</p>

<p><code>sh
$ L=/usr/local/bin/hk &amp;&amp; curl -sL -A "`uname -sp`" https://hk.heroku.com/hk.gz | zcat &gt;$L &amp;&amp; chmod +x $L
</code></p>

<p>インスコ。</p>

<p>```sh
t32k at MBP in ~
$ time heroku apps &gt;/dev/null
real	0m1.980s
user	0m0.711s
sys	0m0.064s</p>

<p>t32k at MBP in ~
$ time hk apps &gt;/dev/null
real	0m0.724s
user	0m0.076s
sys	0m0.019s
```</p>

<p>おぉー、桁が違うぜ！ってことで、速いもの好きなあなたはインストールしてみてはどうでしょうか。</p>

<p>僕もGoで作ったCLIツール作りたい٩(๑❛ᴗ❛๑)۶</p>
